{% extends "base.html" %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='nova_movimentacao.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      position: relative;
    }

    .close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
{% endblock %}

{% block content %}
<form method="POST" class="form-movimentacao">
  <div class="form-header">
    <h3>Materiais:</h3>
    <button type="button" class="add-button" onclick="abrirModal('modal-material')">+</button>
  </div>
  <div id="materiais-container">
    {% for mm in movimentacao.materiais %}
    <div class="material-row">
      <select name="material_id[]" class="material-select" required>
        <option value="">-- Selecione --</option>
        {% for material in materiais %}
          <option value="{{ material.id }}" {% if material.id == mm.material_id %}selected{% endif %}>
            {{ material.nome }}
          </option>
        {% endfor %}
      </select>

      <input type="number" name="quantidade[]" min="1" value="{{ mm.quantidade }}" required>

      <input type="number" name="quantidade_ok[]" min="0" placeholder="OK" value="{{ mm.quantidade_ok or '' }}">

      <input type="number" name="quantidade_sem_retorno[]" min="0" placeholder="Sem Retorno" value="{{ mm.quantidade_sem_retorno or '' }}">

      <button type="button" class="remove-button" onclick="removerLinha(this)">X</button>
    </div>
    {% else %}
    <div class="material-row">
      <select name="material_id[]" class="material-select" required>
        <option value="">-- Selecione --</option>
        {% for material in materiais %}
          <option value="{{ material.id }}">{{ material.nome }}</option>
        {% endfor %}
      </select>

      <input type="number" name="quantidade[]" min="1" placeholder="1" value="1" required>

      <input type="number" name="quantidade_ok[]" min="0" placeholder="Qtd OK">

      <input type="number" name="quantidade_sem_retorno[]" min="0" placeholder="Qtd Sem Retorno">

      <button type="button" class="remove-button" onclick="removerLinha(this)">X</button>
    </div>
    {% endfor %}
  </div>

  <button type="button" class="add-button" onclick="adicionarLinha()">+ Adicionar Material</button>
  <br><br>

  <label>Cliente (opcional):</label>
  <div class="input-with-button">
    <select name="cliente_id" id="cliente-select">
      <option value="">-- Selecione --</option>
      {% for cliente in clientes %}
        <option value="{{ cliente.id }}" {% if movimentacao.cliente_id == cliente.id %}selected{% endif %}>{{ cliente.nome }}</option>
      {% endfor %}
    </select>
    <button type="button" class="add-button" onclick="abrirModal('modal-cliente')">+</button>
  </div>

  <label>Ordem de Serviço:</label>
  <input type="text" name="ordem_servico" value="{{ movimentacao.ordem_servico or '' }}"><br>

  <label>Colaboradores:</label>
  <select name="funcionario" id="colaborador-select" required>
    <option value="">-- Selecione --</option>
    {% for nome in colaboradores %}
      <option value="{{ nome }}" {% if movimentacao.funcionario == nome %}selected{% endif %}>{{ nome }}</option>
    {% endfor %}
  </select>

  <label>Data de Retirada:</label>
  <input type="datetime-local" name="data_retirada" id="data-retirada" value="{{ movimentacao.data_retirada.strftime('%Y-%m-%dT%H:%M') if movimentacao.data_retirada else '' }}" required><br>

  <label>Prazo de Devolução:</label>
  <input type="datetime-local" name="prazo_devolucao" value="{{ movimentacao.prazo_devolucao.strftime('%Y-%m-%dT%H:%M') if movimentacao.prazo_devolucao else '' }}"><br>

  <label>Motivo:</label>
  <select name="motivo">
    <option value="">-- Selecione --</option>
    <option value="manutenção" {% if movimentacao.motivo == 'manutenção' %}selected{% endif %}>Manutenção</option>
    <option value="emprestimo" {% if movimentacao.motivo == 'emprestimo' %}selected{% endif %}>Empréstimo</option>
    <option value="teste" {% if movimentacao.motivo == 'teste' %}selected{% endif %}>Teste</option>
    <option value="instalação" {% if movimentacao.motivo == 'instalação' %}selected{% endif %}>Instalação</option>
    <option value="montagem" {% if movimentacao.motivo == 'montagem' %}selected{% endif %}>Montagem</option>
  </select><br>

  <label>Observação:</label>
  <textarea name="observacao">{{ movimentacao.observacao or '' }}</textarea><br>

  <button type="submit" class="btn-salvar-form">Salvar</button>
</form>

<div class="modal" id="modal-material">
  <div class="modal-content">
    <span class="close" onclick="fecharModal('modal-material')">&times;</span>
    <h3>Novo Material</h3>
    <form id="form-material" class="form-modal">
      <input type="text" name="nome" placeholder="Nome" required>
      <input type="number" name="quantidade" placeholder="Quantidade" required>
      <input type="number" name="lote" placeholder="Lote">
      <input type="number" name="estoque_minimo_chuva" placeholder="Estoque Mínimo (Chuva)" required>
      <input type="number" name="estoque_minimo_seco" placeholder="Estoque Mínimo (Seco)" required>
      <button type="submit" class="btn-salvar">Salvar</button>
    </form>
  </div>
</div>

<div class="modal" id="modal-cliente">
  <div class="modal-content">
    <span class="close" onclick="fecharModal('modal-cliente')">&times;</span>
    <h3>Novo Cliente</h3>
    <form id="form-cliente" class="form-modal">
      <input type="text" name="nome" placeholder="Nome do cliente" required>
      <button type="submit" class="btn-salvar">Salvar</button>
    </form>
  </div>
</div>

<div class="modal" id="modal-colaborador">
  <div class="modal-content">
    <span class="close" onclick="fecharModal('modal-colaborador')">&times;</span>
    <h3>Novo Colaborador</h3>
    <form id="form-colaborador" class="form-modal">
      <input type="text" name="nome" placeholder="Nome do colaborador" required>
      <button type="submit" class="btn-salvar">Salvar</button>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  function formatDateToLocal(date) {
    const pad = (n) => n.toString().padStart(2, '0');
    const year = date.getFullYear();
    const month = pad(date.getMonth() + 1);
    const day = pad(date.getDate());
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  document.addEventListener("DOMContentLoaded", function () {
  
    const dataRetiradaInput = document.getElementById("data-retirada");
    if (dataRetiradaInput && !dataRetiradaInput.value) {
      dataRetiradaInput.value = formatDateToLocal(new Date());
    }
  });


  const materiaisData = {{ materiais_json|tojson }};

  function abrirModal(id) {
    document.getElementById(id).style.display = 'block';
  }

  function fecharModal(id) {
    document.getElementById(id).style.display = 'none';
  }

  function adicionarLinha() {
    const container = document.getElementById("materiais-container");
    const novaLinha = document.createElement("div");
    novaLinha.className = "material-row";

    const select = document.createElement("select");
    select.name = "material_id[]";
    select.required = true;
    select.className = "material-select";

    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.text = "-- Selecione --";
    select.appendChild(defaultOption);

    materiaisData.forEach(material => {
      const option = document.createElement("option");
      option.value = material.id;
      option.textContent = `${material.nome}`;
      select.appendChild(option);
    });

    const inputQtd = document.createElement("input");
    inputQtd.type = "number";
    inputQtd.name = "quantidade[]";
    inputQtd.min = "1";
    inputQtd.placeholder = "Qtd";
    inputQtd.required = true;

    const inputQtdOk = document.createElement("input");
    inputQtdOk.type = "number";
    inputQtdOk.name = "quantidade_ok[]";
    inputQtdOk.min = "0";
    inputQtdOk.placeholder = "Qtd OK";

    const inputQtdSemRetorno = document.createElement("input");
    inputQtdSemRetorno.type = "number";
    inputQtdSemRetorno.name = "quantidade_sem_retorno[]";
    inputQtdSemRetorno.min = "0";
    inputQtdSemRetorno.placeholder = "Qtd Sem Retorno";

    const removeButton = document.createElement("button");
    removeButton.type = "button";
    removeButton.className = "remove-button";
    removeButton.textContent = "X";
    removeButton.onclick = function () {
      removerLinha(removeButton);
    };

    novaLinha.appendChild(select);
    novaLinha.appendChild(inputQtd);
    novaLinha.appendChild(inputQtdOk);
    novaLinha.appendChild(inputQtdSemRetorno);
    novaLinha.appendChild(removeButton);
    container.appendChild(novaLinha);

    $(select).select2({
      placeholder: 'Selecione ou pesquise um material',
      width: '100%'
    });
  }

  function removerLinha(botao) {
    const container = document.getElementById("materiais-container");
    if (container.children.length > 1) {
      botao.parentElement.remove();
    }
  }

  $(document).ready(function () {
    $('.material-select').select2({
      placeholder: 'Selecione ou pesquise um material',
      width: '100%'
    });

    $('#cliente-select').select2({
      placeholder: 'Selecione ou pesquise um cliente',
      allowClear: true,
      width: '100%'
    });

    $('#colaborador-select').select2({
      placeholder: 'Selecione ou pesquise um colaborador',
      allowClear: true,
      width: '100%'
    });
  });

  document.getElementById('form-material').addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    const response = await fetch('/materiais/novo', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      const nome = formData.get('nome');
      const idTemp = 'temp_' + Date.now(); 

      document.querySelectorAll('.material-select').forEach(select => {
        const option = document.createElement('option');
        option.text = nome;
        option.value = idTemp;
        select.appendChild(option);
      });

      fecharModal('modal-material');
      this.reset();
    } else {
      alert('Erro ao cadastrar material.');
    }
  });

  document.getElementById('form-cliente').addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    const response = await fetch('/clientes/novo', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      const data = await response.json();

      const clienteSelect = document.getElementById('cliente-select');
      const option = document.createElement('option');
      option.text = data.nome;
      option.value = data.id;
      clienteSelect.appendChild(option);

      $(clienteSelect).val(data.id).trigger('change');

      fecharModal('modal-cliente');
      this.reset();
    } else {
      alert('Erro ao cadastrar cliente.');
    }
  });

  document.getElementById('form-colaborador').addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    const response = await fetch('/colaboradores/novo', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      const nome = formData.get('nome');
      const colaboradorSelect = document.getElementById('colaborador-select');
      const option = document.createElement('option');
      option.text = nome;
      option.value = nome;
      colaboradorSelect.appendChild(option);

      $(colaboradorSelect).val(nome).trigger('change');

      fecharModal('modal-colaborador');
      this.reset();
    } else {
      alert('Erro ao cadastrar colaborador.');
    }
  });
</script>
{% endblock %}
