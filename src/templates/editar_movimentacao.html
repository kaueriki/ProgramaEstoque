{% extends "base.html" %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='editar_movimentacao.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Editar Movimentação</h2>

  <form method="POST">
    <div id="materiais-container" class="mb-3">
      {% for mm in movimentacao.materiais %}
      <div class="row align-items-end mb-3 material-item">
        <div class="col-md-6">
          <label class="form-label">Material</label>
          <select class="form-select select2-material" name="material_id[]" required>
            {% for mat in materiais %}
            <option value="{{ mat.id }}" {% if mat.id == mm.material_id %}selected{% endif %}>
              {{ mat.nome }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Qtd. Enviada:</label>
          <input type="number" class="form-control" name="quantidade[]" value="{{ mm.quantidade }}" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Qtd. OK:</label>
          <input type="number" class="form-control" name="quantidade_ok[]" value="{{ mm.quantidade_ok or '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Qtd. Sem Retorno:</label>
          <input type="number" class="form-control" name="quantidade_sem_retorno[]" value="{{ mm.quantidade_sem_retorno or '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Qtd. Não OK:</label>
          {% set ok = mm.quantidade_ok or 0 %}
          {% set sem_retorno = mm.quantidade_sem_retorno or 0 %}
          <input type="number" class="form-control" name="quantidade_nao_ok[]" readonly
                 value="{{ mm.quantidade - (ok + sem_retorno) }}">
        </div>
        <div class="col-md-3">
          <button type="button" class="btn btn-danger btn-remove-material">Remover</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <button type="button" class="btn btn-success mb-3" id="add-material">+ Adicionar Material</button>

    <div class="mb-3">
      <label for="cliente_id" class="form-label">Cliente</label>
      <select class="form-select select2" id="cliente_id" name="cliente_id">
        <option value="">- Nenhum -</option>
        {% for cli in clientes %}
        <option value="{{ cli.id }}" {% if movimentacao.cliente_id == cli.id %}selected{% endif %}>
          {{ cli.nome }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="ordem_servico" class="form-label">Ordem de Serviço</label>
      <input type="text" class="form-control" id="ordem_servico" name="ordem_servico"
        value="{{ movimentacao.ordem_servico }}">
    </div>

    <div class="mb-3">
      <label for="funcionario" class="form-label">Funcionário</label>
      <select name="funcionario" id="funcionario" class="form-select select2" required>
        <option value="{{ movimentacao.funcionario }}">{{ movimentacao.funcionario }}</option>
        {% set funcionarios = [
          "Adauto", "Andre", "Daniel", "Dener", "Denilson", "Domerice", "Duda", "Eduardo", "Elvis", "Fabiano", "Felipe",
          "Gabriel", "Geraldo", "Guilherme", "Hudson", "Jason", "Joao Vitor", "Jonielson", "Kaue", "Leonardo", "Luan",
          "Lucas", "Lucas Febba", "Marcus", "Marlon", "Matheus Barbosa", "Matheus Miranda", "Pablo", "Renan", "Ricardo",
          "Robert", "Thais", "Thiago", "Vanderson"
        ] %}
        {% for nome in funcionarios %}
        {% if nome != movimentacao.funcionario %}
        <option value="{{ nome }}">{{ nome }}</option>
        {% endif %}
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="prazo_devolucao" class="form-label">Prazo de Devolução</label>
      <input type="datetime-local" class="form-control" id="prazo_devolucao" name="prazo_devolucao"
        value="{{ movimentacao.prazo_devolucao.strftime('%Y-%m-%dT%H:%M') if movimentacao.prazo_devolucao }}">
    </div>

    <div class="mb-3">
      <label for="motivo" class="form-label">Motivo</label>
      <select name="motivo" id="motivo" class="form-select select2">
        <option value="">-- Selecione --</option>
        <option value="manutenção" {% if movimentacao.motivo == 'manutenção' %}selected{% endif %}>Manutenção</option>
        <option value="emprestimo" {% if movimentacao.motivo == 'emprestimo' %}selected{% endif %}>Empréstimo</option>
        <option value="teste" {% if movimentacao.motivo == 'teste' %}selected{% endif %}>Teste</option>
        <option value="instalação" {% if movimentacao.motivo == 'instalação' %}selected{% endif %}>Instalação</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="observacao" class="form-label">Observação</label>
      <textarea class="form-control" id="observacao" name="observacao" rows="3">{{ movimentacao.observacao or '' }}</textarea>
    </div>

    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
    <a href="{{ url_for('movimentacoes.listar_movimentacoes') }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<div id="material-template" style="display: none;">
  <div class="row align-items-end mb-3 material-item">
    <div class="col-md-6">
      <label class="form-label">Material</label>
      <select class="form-select select2-material" name="material_id[]" required>
        {% for mat in materiais %}
        <option value="{{ mat.id }}">{{ mat.nome }} (Estoque: {{ mat.quantidade }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Qtd. Enviada:</label>
      <input type="number" class="form-control" name="quantidade[]" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Qtd. OK:</label>
      <input type="number" class="form-control" name="quantidade_ok[]">
    </div>
    <div class="col-md-2">
      <label class="form-label">Qtd. Sem Retorno:</label>
      <input type="number" class="form-control" name="quantidade_sem_retorno[]">
    </div>
    <div class="col-md-2">
      <label class="form-label">Qtd. Não OK:</label>
      <input type="number" class="form-control" name="quantidade_nao_ok[]" readonly>
    </div>
    <div class="col-md-3 mt-2">
      <button type="button" class="btn btn-danger btn-remove-material">Remover</button>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function () {
    $('.select2').select2({ width: '100%', language: "pt-BR" });
    $('.select2-material').select2({ width: '100%', placeholder: 'Selecione um material', language: "pt-BR" });

    $('#add-material').on('click', function () {
      const container = $('#materiais-container');
      const templateHtml = $('#material-template').html();
      const newMaterial = $(templateHtml);

      container.append(newMaterial);

      newMaterial.find('.select2-material').select2({
        width: '100%',
        placeholder: 'Selecione um material',
        language: "pt-BR"
      });
    });

    $(document).on('click', '.btn-remove-material', function () {
      $(this).closest('.material-item').remove();
    });

    function calcularNaoOk(item) {
      const qtdEnviada = parseInt(item.find('input[name="quantidade[]"]').val()) || 0;
      const qtdOk = parseInt(item.find('input[name="quantidade_ok[]"]').val()) || 0;
      const qtdSemRetorno = parseInt(item.find('input[name="quantidade_sem_retorno[]"]').val()) || 0;
      const naoOk = qtdEnviada - (qtdOk + qtdSemRetorno);
      item.find('input[name="quantidade_nao_ok[]"]').val(naoOk >= 0 ? naoOk : 0);
    }

    $(document).on('input', 'input[name="quantidade[]"], input[name="quantidade_ok[]"], input[name="quantidade_sem_retorno[]"]', function () {
      const item = $(this).closest('.material-item');
      calcularNaoOk(item);
    });
  });
</script>
{% endblock %}
